<div class="container-fluid">
  <!-- Encabezado -->
  <div class="mb-4">
    <h2 class="fw-bold mb-3">Máquinas</h2>
    <div class="d-flex justify-content-between align-items-center">
      <!-- Tabs -->
      <ul class="nav nav-tabs border-0">
        <li class="nav-item">
          <a
            class="nav-link fw-semibold"
            [class.active]="tabActivo === 'activas'"
            (click)="cambiarTab('activas')"
            style="cursor: pointer;"
          >
            ACTIVAS
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link fw-semibold"
            [class.active]="tabActivo === 'inactivas'"
            (click)="cambiarTab('inactivas')"
            style="cursor: pointer;"
          >
            INACTIVAS
          </a>
        </li>
        <li class="nav-item">
          <a
            class="nav-link fw-semibold"
            [class.active]="tabActivo === 'mantenimiento'"
            (click)="cambiarTab('mantenimiento')"
            style="cursor: pointer;"
          >
            MANTENIMIENTO
          </a>
        </li>
      </ul>
      <!-- Buscador -->
      <div class="input-group" style="width: 300px;">
        <input type="text" class="form-control" placeholder="Buscar máquina" 
                [(ngModel)]="searchTerm" [ngModelOptions]="{standalone: true}">
        <button class="btn btn-outline-secondary" type="button">
          <i class="bi bi-search"></i>
        </button>
      </div>
    </div>
  </div>

  <!-- Botón Nueva Máquina -->
  <button class="btn btn-info text-white fw-bold mb-3"
        (click)="abrirModal()"
        style="background-color: #17a2b8; border: none; padding: 0.5rem 1.5rem; border-radius: 6px;">
    + NUEVA MÁQUINA
  </button>

  <!-- Tabla -->
  <div class="card shadow-sm border-0">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover mb-0 align-middle">
          <thead class="table-light">
            <tr>
              <th>Nombre</th>
              <th>N° Serie</th>
              <th>Modelo</th>
              <th>Tipo</th>
              <th>Ubicación</th>
              <th style="width: 50px;"></th>
            </tr>
          </thead>
          <tbody>
            @if (isLoading) {
              <tr>
                <td colspan="6" class="text-center py-4">
                  <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Cargando...</span>
                  </div>
                </td>
              </tr>
            }
            @if (!isLoading && maquinasMostradas.length === 0) {
              <tr>
                <td colspan="6" class="text-center py-4 text-muted">
                  No hay máquinas para mostrar
                </td>
              </tr>
            }
            @for (maquina of maquinasMostradas; track maquina.id) {
              <tr>
                <td class="fw-semibold">{{ maquina.nombre }}</td>
                <td>{{ maquina.numSerie }}</td>
                <td>{{ maquina.modelo }}</td>
                <td>{{ maquina.tipo }}</td>
                <td>{{ maquina.ubicacion || '-' }}</td>
                <td class="text-end position-relative">
                  <button
                    class="btn btn-link text-dark p-0"
                    (click)="toggleMenu(maquina.id)"
                    style="font-size: 1.5rem; line-height: 1;"
                  >
                    ⋮
                  </button>
                  <!-- Menú desplegable -->
                  @if (menuAbierto === maquina.id) {
                    <div class="dropdown-menu-custom">
                      <button class="dropdown-item-custom"
                              (click)="verInfo(maquina); $event.stopPropagation()">
                        <i class="bi bi-info-circle text-primary"></i> Ver detalle
                      </button>
                      @if (maquina.estado === 'activa') {
                        <button class="dropdown-item-custom"
                                (click)="cambiarEstado(maquina, 'mantenimiento'); $event.stopPropagation()">
                          <i class="bi bi-wrench text-warning"></i> Mantenimiento
                        </button>
                        <button class="dropdown-item-custom"
                                (click)="cambiarEstado(maquina, 'inactiva'); $event.stopPropagation()">
                          <i class="bi bi-pause-circle text-secondary"></i> Desactivar
                        </button>
                      }
                      @if (maquina.estado === 'inactiva') {
                        <button class="dropdown-item-custom"
                                (click)="cambiarEstado(maquina, 'activa'); $event.stopPropagation()">
                          <i class="bi bi-play-circle text-success"></i> Activar
                        </button>
                      }
                      @if (maquina.estado === 'mantenimiento') {
                        <button class="dropdown-item-custom"
                                (click)="cambiarEstado(maquina, 'activa'); $event.stopPropagation()">
                          <i class="bi bi-check-circle text-success"></i> Finalizar mantenimiento
                        </button>
                      }
                      <button class="dropdown-item-custom text-danger"
                              (click)="eliminarMaquina(maquina); $event.stopPropagation()">
                        <i class="bi bi-trash"></i> Eliminar
                      </button>
                    </div>
                  }

                </td>
              </tr>
            }
          </tbody>
        </table>
        @if (modalAbierto) {
        <div class="modal-overlay" (click)="cerrarModal()">
          <div class="modal-content" (click)="$event.stopPropagation()">

            <!-- Header del modal -->
            <div class="modal-header-custom">
              <h4 class="modal-title">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 10px;">
                  <path d="M8 4.754a3.246 3.246 0 1 0 0 6.492 3.246 3.246 0 0 0 0-6.492zM5.754 8a2.246 2.246 0 1 1 4.492 0 2.246 2.246 0 0 1-4.492 0z"/>
                  <path d="M9.796 1.343c-.527-1.79-3.065-1.79-3.592 0l-.094.319a.873.873 0 0 1-1.255.52l-.292-.16c-1.64-.892-3.433.902-2.54 2.541l.159.292a.873.873 0 0 1-.52 1.255l-.319.094c-1.79.527-1.79 3.065 0 3.592l.319.094a.873.873 0 0 1 .52 1.255l-.16.292c-.892 1.64.901 3.434 2.541 2.54l.292-.159a.873.873 0 0 1 1.255.52l.094.319c.527 1.79 3.065 1.79 3.592 0l.094-.319a.873.873 0 0 1 1.255-.52l.292.16c1.64.893 3.434-.902 2.54-2.541l-.159-.292a.873.873 0 0 1 .52-1.255l.319-.094c1.79-.527 1.79-3.065 0-3.592l-.319-.094a.873.873 0 0 1-.52-1.255l.16-.292c.893-1.64-.902-3.433-2.541-2.54l-.292.159a.873.873 0 0 1-1.255-.52l-.094-.319z"/>
                </svg>
                Nueva Máquina
              </h4>
              <button class="btn-close-custom" (click)="cerrarModal()">✕</button>
            </div>

            <!-- Body del modal -->
            <form [formGroup]="nuevaMaquinaForm" (ngSubmit)="guardarMaquina()" novalidate>
              <div class="modal-body-custom">

                <!-- Nombre * -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M1 2.5A1.5 1.5 0 0 1 2.5 1h3A1.5 1.5 0 0 1 7 2.5v3A1.5 1.5 0 0 1 5.5 7h-3A1.5 1.5 0 0 1 1 5.5v-3zM2.5 2a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 1h3A1.5 1.5 0 0 1 15 2.5v3A1.5 1.5 0 0 1 13.5 7h-3A1.5 1.5 0 0 1 9 5.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zM1 10.5A1.5 1.5 0 0 1 2.5 9h3A1.5 1.5 0 0 1 7 10.5v3A1.5 1.5 0 0 1 5.5 15h-3A1.5 1.5 0 0 1 1 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3zm6.5.5A1.5 1.5 0 0 1 10.5 9h3a1.5 1.5 0 0 1 1.5 1.5v3a1.5 1.5 0 0 1-1.5 1.5h-3A1.5 1.5 0 0 1 9 13.5v-3zm1.5-.5a.5.5 0 0 0-.5.5v3a.5.5 0 0 0 .5.5h3a.5.5 0 0 0 .5-.5v-3a.5.5 0 0 0-.5-.5h-3z"/>
                    </svg>
                    Nombre <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control-custom"
                    formControlName="nombre"
                    placeholder="Ej: Cosechadora John Deere"
                    [class.is-invalid]="f.nombre.touched && f.nombre.invalid">
                  @if (f.nombre.touched && f.nombre.invalid) {
                    <div class="error-message">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      @if (f.nombre.hasError('required')) {
                        <span>El nombre es obligatorio.</span>
                      }
                      @if (f.nombre.hasError('minlength')) {
                        <span>Mínimo 3 caracteres.</span>
                      }
                      @if (f.nombre.hasError('maxlength')) {
                        <span>Máximo 50 caracteres.</span>
                      }
                    </div>
                  }
                </div>

                <!-- N° Serie * -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M12.643 15C13.979 15 15 13.845 15 12.5V5H1v7.5C1 13.845 2.021 15 3.357 15h9.286zM5.5 7h5a.5.5 0 0 1 0 1h-5a.5.5 0 0 1 0-1zM.8 1a.8.8 0 0 0-.8.8V3a.8.8 0 0 0 .8.8h14.4A.8.8 0 0 0 16 3V1.8a.8.8 0 0 0-.8-.8H.8z"/>
                    </svg>
                    Número de Serie <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control-custom"
                    formControlName="numSerie"
                    placeholder="Ej: ABC123XYZ"
                    maxlength="20"
                    [class.is-invalid]="f.numSerie.touched && f.numSerie.invalid">
                  @if (f.numSerie.touched && f.numSerie.invalid) {
                    <div class="error-message">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      @if (f.numSerie.hasError('required')) {
                        <span>El número de serie es obligatorio.</span>
                      }
                      @if (f.numSerie.hasError('pattern')) {
                        <span>Formato inválido (alfanumérico, 6-20 caracteres).</span>
                      }
                    </div>
                  }
                </div>

                <!-- Modelo * -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v13.5a.5.5 0 0 1-.777.416L8 13.101l-5.223 2.815A.5.5 0 0 1 2 15.5V2zm2-1a1 1 0 0 0-1 1v12.566l4.723-2.482a.5.5 0 0 1 .554 0L13 14.566V2a1 1 0 0 0-1-1H4z"/>
                    </svg>
                    Modelo <span class="text-danger">*</span>
                  </label>
                  <input
                    type="text"
                    class="form-control-custom"
                    formControlName="modelo"
                    placeholder="Ej: S780"
                    [class.is-invalid]="f.modelo.touched && f.modelo.invalid">
                  @if (f.modelo.touched && f.modelo.invalid) {
                    <div class="error-message">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      @if (f.modelo.hasError('required')) {
                        <span>El modelo es obligatorio.</span>
                      }
                      @if (f.modelo.hasError('minlength')) {
                        <span>Mínimo 2 caracteres.</span>
                      }
                    </div>
                  }
                </div>

                <!-- Fecha Compra * -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M3.5 0a.5.5 0 0 1 .5.5V1h8V.5a.5.5 0 0 1 1 0V1h1a2 2 0 0 1 2 2v11a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V3a2 2 0 0 1 2-2h1V.5a.5.5 0 0 1 .5-.5zM1 4v10a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V4H1z"/>
                    </svg>
                    Fecha Compra <span class="text-danger">*</span>
                  </label>
                  <input
                    type="date"
                    class="form-control-custom"
                    formControlName="fechaCompra"
                    [class.is-invalid]="f.fechaCompra.touched && f.fechaCompra.invalid">
                  @if (f.fechaCompra.touched && f.fechaCompra.invalid) {
                    <div class="error-message">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      <span>La fecha es obligatoria.</span>
                    </div>
                  }
                </div>

                <!-- Tipo * -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M0 2a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2zm8.5 9.5a.5.5 0 0 1-1 0V5.707L5.354 7.854a.5.5 0 1 1-.708-.708l3-3a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 5.707V11.5z"/>
                    </svg>
                    Tipo <span class="text-danger">*</span>
                  </label>
                  <select
                    class="form-control-custom"
                    formControlName="tipo"
                    [class.is-invalid]="f.tipo.touched && f.tipo.invalid">
                    <option value="">Seleccionar tipo</option>
                    <option value="Tractor">Tractor</option>
                    <option value="Cosechadora">Cosechadora</option>
                    <option value="Empacadora">Empacadora</option>
                    <option value="Fumigadora">Fumigadora</option>
                    <option value="Arado">Arado</option>
                    <option value="Sembradora">Sembradora</option>
                    <option value="Otro">Otro</option>
                  </select>
                  @if (f.tipo.touched && f.tipo.invalid) {
                    <div class="error-message">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      <span>El tipo es obligatorio.</span>
                    </div>
                  }
                </div>

                <!-- Ubicación (Opcional) -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M8 16s6-5.686 6-10A6 6 0 0 0 2 6c0 4.314 6 10 6 10zm0-7a3 3 0 1 1 0-6 3 3 0 0 1 0 6z"/>
                    </svg>
                    Ubicación <span class="text-muted">(Opcional)</span>
                  </label>
                  <input
                    type="text"
                    class="form-control-custom"
                    formControlName="ubicacion"
                    placeholder="Ej: Finca 1 - Almacén Norte"
                    [class.is-invalid]="f.ubicacion.touched && f.ubicacion.invalid">
                  @if (f.ubicacion.touched && f.ubicacion.invalid) {
                    <div class="error-message">
                      <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                        <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z"/>
                        <path d="M7.002 11a1 1 0 1 1 2 0 1 1 0 0 1-2 0zM7.1 4.995a.905.905 0 1 1 1.8 0l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 4.995z"/>
                      </svg>
                      @if (f.ubicacion.hasError('minlength')) {
                        <span>Mínimo 3 caracteres.</span>
                      }
                    </div>
                  }
                </div>

                <!-- Descripción (Opcional) -->
                <div class="form-group-custom">
                  <label class="form-label-custom">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                      <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                      <path d="M3 5.5a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9a.5.5 0 0 1-.5-.5zM3 8a.5.5 0 0 1 .5-.5h9a.5.5 0 0 1 0 1h-9A.5.5 0 0 1 3 8zm0 2.5a.5.5 0 0 1 .5-.5h6a.5.5 0 0 1 0 1h-6a.5.5 0 0 1-.5-.5z"/>
                    </svg>
                    Descripción <span class="text-muted">(Opcional)</span>
                  </label>
                  <textarea
                    class="form-control-custom"
                    formControlName="descripcion"
                    placeholder="Información adicional sobre la máquina"
                    rows="3"
                    style="resize: vertical;"
                  ></textarea>
                </div>

              </div>

              <!-- Footer del modal -->
              <div class="modal-footer-custom">
                <button type="button" class="btn-secondary-custom" (click)="cerrarModal()">
                  Cancelar
                </button>
                <button
                  type="submit"
                  class="btn-primary-custom"
                  [disabled]="nuevaMaquinaForm.invalid">
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16" style="margin-right: 6px;">
                    <path d="M10.97 4.97a.75.75 0 0 1 1.07 1.05l-3.99 4.99a.75.75 0 0 1-1.08.02L4.324 8.384a.75.75 0 1 1 1.06-1.06l2.094 2.093 3.473-4.425a.267.267 0 0 1 .02-.022z"/>
                  </svg>
                  Guardar Máquina
                </button>
              </div>
            </form>

          </div>
        </div>
      }

      </div>
    </div>
  </div>
</div>
